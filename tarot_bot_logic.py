import random
import time
from datetime import datetime
import json

# --- æ¨¡æ“¬è³‡æ–™åº«èˆ‡è¨­å®š ---

def get_card_image(name_en):
    clean_name = name_en.replace(" ", "+")
    return f"https://via.placeholder.com/300x500.png?text={clean_name}"

TAROT_DECK = [
    {
        "name": "0. æ„šè€…", "score": 0, "name_en": "The Fool",
        "image_url": get_card_image("The Fool"),
        "meaning": "å†’éšªã€å¤©çœŸ", "keywords": ["è‡ªç”±", "æµæµª"],
        "desc_up": "è¸ä¸ŠæœªçŸ¥çš„æ—…ç¨‹ï¼Œå……æ»¿é¢¨éšªä½†ä¹Ÿä»£è¡¨ç„¡é™å¯èƒ½ï¼Œé©åˆå¤§è†½å˜—è©¦ã€‚",
        "desc_rev": "éæ–¼é­¯è½æˆ–æ˜¯ä¸æ•¢è¸å‡ºç¬¬ä¸€æ­¥ï¼Œè¨ˆç•«å¯èƒ½ç¼ºä¹å‘¨å…¨çš„è€ƒæ…®ã€‚"
    },
    {
        "name": "I. é­”è¡“å¸«", "score": 1, "name_en": "The Magician",
        "image_url": get_card_image("The Magician"),
        "meaning": "å‰µé€ ã€èƒ½åŠ›", "keywords": ["è¡Œå‹•", "å°ˆæ³¨"],
        "desc_up": "è¬äº‹ä¿±å‚™ï¼Œç¾åœ¨æ­£æ˜¯å±•ç¾èƒ½åŠ›ã€å°‡æƒ³æ³•åŒ–ç‚ºç¾å¯¦çš„æ™‚åˆ»ã€‚",
        "desc_rev": "æœ‰èƒ½åŠ›ä½†ç¼ºä¹æ„å¿—åŠ›ï¼Œæˆ–æ˜¯é­åˆ°æ¬ºé¨™ï¼Œå°å¿ƒè°æ˜åè¢«è°æ˜èª¤ã€‚"
    },
    {
        "name": "II. å¥³ç¥­å¸", "score": 0, "name_en": "The High Priestess",
        "image_url": get_card_image("The High Priestess"),
        "meaning": "ç›´è¦ºã€ç¥ç§˜", "keywords": ["å†·éœ", "æ™ºæ…§"],
        "desc_up": "éœä¸‹å¿ƒä¾†å‚¾è½å…§åœ¨çš„è²éŸ³ï¼Œç­”æ¡ˆè—åœ¨æ½›æ„è­˜è£¡ï¼Œé©åˆéœå®ˆã€‚",
        "desc_rev": "æƒ…ç·’ä¸ç©©ï¼Œéåº¦ä¾è³´ç›´è¦ºè€Œå¿½ç•¥ç¾å¯¦ï¼Œæˆ–æ˜¯å…§å¿ƒå°é–‰æ‹’çµ•æºé€šã€‚"
    },
    {
        "name": "III. çš‡å", "score": 1, "name_en": "The Empress",
        "image_url": get_card_image("The Empress"),
        "meaning": "è±é¥’ã€æ¯æ€§", "keywords": ["ç¹æ¦®", "æ„›"],
        "desc_up": "å……æ»¿æ„›èˆ‡ç¾çš„èƒ½é‡ï¼Œç‰©è³ªèˆ‡æƒ…æ„Ÿä¸Šçš„å¯Œè¶³ï¼Œé©åˆäº«å—ç”Ÿæ´»ã€‚",
        "desc_rev": "éåº¦æººæ„›æˆ–ä¾è³´ä»–äººï¼Œåœ¨æ„Ÿæƒ…æˆ–è²¡å‹™ä¸Šå¯èƒ½å‡ºç¾æ®éœçš„ç‹€æ³ã€‚"
    },
    {
        "name": "IV. çš‡å¸", "score": 1, "name_en": "The Emperor",
        "image_url": get_card_image("The Emperor"),
        "meaning": "æ¬Šå¨ã€çµæ§‹", "keywords": ["è²¬ä»»", "é ˜å°"],
        "desc_up": "é€éè‡ªå¾‹èˆ‡è¦åŠƒä¾†æŒæ§å±€å‹¢ï¼Œå»ºç«‹ç©©å›ºçš„ç§©åºèˆ‡åŸºç¤ã€‚",
        "desc_rev": "å›ºåŸ·å·±è¦‹ã€æ¿«ç”¨æ¬ŠåŠ›ï¼Œæˆ–æ˜¯ç¼ºä¹ç´€å¾‹å°è‡´ç”Ÿæ´»ä¸€åœ˜æ··äº‚ã€‚"
    },
    {
        "name": "V. æ•™çš‡", "score": 1, "name_en": "The Hierophant",
        "image_url": get_card_image("The Hierophant"),
        "meaning": "å‚³çµ±ã€æŒ‡å°", "keywords": ["æ´åŠ©", "ä¿¡å¿µ"],
        "desc_up": "å°‹æ±‚å¿ƒéˆçš„æŒ‡å¼•ï¼Œæˆ–æ˜¯éµå¾ªå‚³çµ±çš„åƒ¹å€¼è§€ï¼Œæœƒæœ‰è²´äººç›¸åŠ©ã€‚",
        "desc_rev": "éåº¦ä¿å®ˆæ­»æ¿ï¼Œæˆ–æ˜¯é­åˆ°éŒ¯èª¤çš„å¼•å°ï¼Œè³ªç–‘ç¾æœ‰çš„é«”åˆ¶ã€‚"
    },
    {
        "name": "VI. æˆ€äºº", "score": 1, "name_en": "The Lovers",
        "image_url": get_card_image("The Lovers"),
        "meaning": "é¸æ“‡ã€æ„›æƒ…", "keywords": ["ç†±æƒ…", "çµåˆ"],
        "desc_up": "é¢è‡¨é‡è¦çš„æŠ‰æ“‡ï¼Œæˆ–æ˜¯å»ºç«‹ä¸€æ®µæ·±åˆ»çš„å¤¥ä¼´/ä¼´ä¾¶é—œä¿‚ã€‚",
        "desc_rev": "é—œä¿‚ç ´è£‚ã€æºé€šä¸è‰¯ï¼Œæˆ–æ˜¯åšå‡ºäº†éŒ¯èª¤çš„é¸æ“‡ï¼Œéœ€é‡æ–°æª¢è¦–åƒ¹å€¼è§€ã€‚"
    },
    {
        "name": "VII. æˆ°è»Š", "score": 1, "name_en": "The Chariot",
        "image_url": get_card_image("The Chariot"),
        "meaning": "å‹åˆ©ã€æ„å¿—", "keywords": ["æ±ºå¿ƒ", "è¡åˆº"],
        "desc_up": "åªè¦ä¿æŒå …å®šçš„æ„å¿—ï¼Œæœ€çµ‚å¿…èƒ½å…‹æœéšœç¤™ï¼Œå–å¾—å‹åˆ©ã€‚",
        "desc_rev": "å¤±å»æ§åˆ¶ã€é­¯è½è¡Œäº‹å°è‡´å¤±æ•—ï¼Œæˆ–æ˜¯åŠé€”è€Œå»¢ç¼ºä¹æ¯…åŠ›ã€‚"
    },
    {
        "name": "VIII. åŠ›é‡", "score": 1, "name_en": "Strength",
        "image_url": get_card_image("Strength"),
        "meaning": "å‹‡æ°£ã€åŒ…å®¹", "keywords": ["ä¿¡å¿ƒ", "è€å¿ƒ"],
        "desc_up": "çœŸæ­£çš„åŠ›é‡ä¸æ˜¯æ­¦åŠ›ï¼Œè€Œæ˜¯ä»¥æŸ”å…‹å‰›çš„å…§åœ¨éŸŒæ€§èˆ‡åŒ…å®¹ã€‚",
        "desc_rev": "å¤±å»ä¿¡å¿ƒã€è»Ÿå¼±é€€ç¸®ï¼Œæˆ–æ˜¯æƒ…ç·’å¤±æ§ç„¡æ³•æŒæ§å±€é¢ã€‚"
    },
    {
        "name": "IX. éš±å£«", "score": 0, "name_en": "The Hermit",
        "image_url": get_card_image("The Hermit"),
        "meaning": "å…§çœã€å­¤ç¨", "keywords": ["æ¢ç´¢", "æ²ˆæ¾±"],
        "desc_up": "æš«æ™‚é é›¢äººç¾¤ï¼Œç¨è‡ªæ€è€ƒå°‹æ‰¾çœŸç†ï¼Œæ™ºæ…§å°‡åœ¨ç¨è™•ä¸­ç”¢ç”Ÿã€‚",
        "desc_rev": "éåº¦å­¤åƒ»ã€èˆ‡ä¸–éš”çµ•ï¼Œæˆ–æ˜¯å› ç‚ºå®³æ€•é¢å°ç¾å¯¦è€Œé€ƒé¿ã€‚"
    },
    {
        "name": "X. å‘½é‹ä¹‹è¼ª", "score": 1, "name_en": "Wheel of Fortune",
        "image_url": get_card_image("Wheel of Fortune"),
        "meaning": "æ©Ÿé‹ã€è½‰è®Š", "keywords": ["æ™‚æ©Ÿ", "å¹¸é‹"],
        "desc_up": "å‘½é‹çš„è½‰å‹•ä¸ç”±äººæ§åˆ¶ï¼Œé †å‹¢è€Œç‚ºæ˜¯æœ€å¥½çš„ç­–ç•¥ï¼Œè½‰æ©Ÿå·²åˆ°ã€‚",
        "desc_rev": "é‹æ°£ä¸ä½³ã€è¨ˆç•«å—é˜»ï¼Œæˆ–æ˜¯æŠ—æ‹’æ”¹è®Šå°è‡´éŒ¯å¤±è‰¯æ©Ÿã€‚"
    },
    {
        "name": "XI. æ­£ç¾©", "score": 0, "name_en": "Justice",
        "image_url": get_card_image("Justice"),
        "meaning": "å…¬å¹³ã€å› æœ", "keywords": ["æ±ºç­–", "å¹³è¡¡"],
        "desc_up": "ç¨®ç“œå¾—ç“œï¼Œç¾åœ¨æ˜¯æª¢è¦–éå»è¡Œç‚ºå¾Œæœçš„æ™‚åˆ»ï¼Œè¿½æ±‚å…¬å¹³ã€‚",
        "desc_rev": "ä¸å…¬å¹³çš„å¾…é‡ã€åè¦‹ï¼Œæˆ–æ˜¯å› ç‚ºçŒ¶è±«ä¸æ±ºè€Œç„¡æ³•åšå‡ºæ±ºå®šã€‚"
    },
    {
        "name": "XII. åŠäºº", "score": -1, "name_en": "The Hanged Man",
        "image_url": get_card_image("The Hanged Man"),
        "meaning": "çŠ§ç‰²ã€ç­‰å¾…", "keywords": ["é †æœ", "è§€é»"],
        "desc_up": "æ›å€‹è§’åº¦çœ‹ä¸–ç•Œï¼Œæœ‰æ™‚å€™æš«æ™‚çš„åœæ»¯æ˜¯ç‚ºäº†æ›´å¤§çš„è¦ºé†’ã€‚",
        "desc_rev": "ç„¡è¬‚çš„çŠ§ç‰²ã€é‘½ç‰›è§’å°–ï¼Œæˆ–æ˜¯å› ç‚ºä¸é¡˜ä»˜å‡ºè€Œå¡åœ¨åŸåœ°ã€‚"
    },
    {
        "name": "XIII. æ­»ç¥", "score": -1, "name_en": "Death",
        "image_url": get_card_image("Death"),
        "meaning": "çµæŸã€é‡ç”Ÿ", "keywords": ["æ”¹è®Š", "æ–·æ¨é›¢"],
        "desc_up": "å‘Šåˆ¥èˆŠæœ‰çš„æ¨¡å¼ï¼Œé›–ç„¶ç—›è‹¦å»æ˜¯è¿æ¥æ–°ç”Ÿçš„å¿…ç¶“ä¹‹è·¯ã€‚",
        "desc_rev": "æŠ—æ‹’æ”¹è®Šã€æ­»æŠ“è‘—éå»ä¸æ”¾ï¼Œå°è‡´ç—›è‹¦å»¶é•·ç„¡æ³•é‡ç”Ÿã€‚"
    },
    {
        "name": "XIV. ç¯€åˆ¶", "score": 1, "name_en": "Temperance",
        "image_url": get_card_image("Temperance"),
        "meaning": "å¹³è¡¡ã€ç™‚ç™’", "keywords": ["æºé€š", "èåˆ"],
        "desc_up": "åœ¨æ¥µç«¯ä¹‹é–“æ‰¾åˆ°å¹³è¡¡é»ï¼Œä¿æŒè€å¿ƒèˆ‡é©åº¦çš„ç¯€å¥ã€‚",
        "desc_rev": "å¤±å»å¹³è¡¡ã€éåº¦æ®éœæˆ–æ¥µç«¯å£“æŠ‘ï¼Œæºé€šä¸Šå‡ºç¾å•é¡Œã€‚"
    },
    {
        "name": "XV. æƒ¡é­”", "score": -1, "name_en": "The Devil",
        "image_url": get_card_image("The Devil"),
        "meaning": "æŸç¸›ã€æ…¾æœ›", "keywords": ["èª˜æƒ‘", "ä¾è³´"],
        "desc_up": "è¢«ç‰©è³ªæˆ–æ…¾æœ›æ‰€ç¶‘ç¶ï¼Œæ„è­˜åˆ°é€™äº›æ·é–å…¶å¯¦æ˜¯è‡ªå·±æˆ´ä¸Šçš„ã€‚",
        "desc_rev": "é–‹å§‹è¦ºé†’ã€å˜—è©¦æ“ºè„«æŸç¸›ï¼Œæˆ–æ˜¯æ²ˆæººæ›´æ·±ç„¡æ³•è‡ªæ‹”ã€‚"
    },
    {
        "name": "XVI. é«˜å¡”", "score": -1, "name_en": "The Tower",
        "image_url": get_card_image("The Tower"),
        "meaning": "æ¯€æ»…ã€é©Ÿè®Š", "keywords": ["å´©å£", "è¦ºé†’"],
        "desc_up": "çªå¦‚å…¶ä¾†çš„æ”¹è®Šé›–ç„¶éœ‡æ’¼ï¼Œä½†èƒ½æ‰“ç ´è™›å‡çš„å¹»è±¡ã€‚",
        "desc_rev": "å‹‰å¼·ç¶­æŒç¾ç‹€ä½†å…§éƒ¨å·²è…å£ï¼Œæˆ–æ˜¯ç½é›£éå¾Œçš„é‡å»ºæœŸã€‚"
    },
    {
        "name": "XVII. æ˜Ÿæ˜Ÿ", "score": 1, "name_en": "The Star",
        "image_url": get_card_image("The Star"),
        "meaning": "å¸Œæœ›ã€éˆæ„Ÿ", "keywords": ["ç™‚ç™’", "é¡˜æ™¯"],
        "desc_up": "æš´é¢¨é›¨å¾Œçš„å¯§éœï¼Œå¤©ä¸Šçš„æ˜Ÿå…‰æŒ‡å¼•è‘—æœªä¾†çš„æ–¹å‘ã€‚",
        "desc_rev": "å¤±å»å¸Œæœ›ã€æ‚²è§€ï¼Œæˆ–æ˜¯å¥½é«˜é¨–é ï¼Œåªæœƒåšå¤¢è€Œä¸è¡Œå‹•ã€‚"
    },
    {
        "name": "XVIII. æœˆäº®", "score": -1, "name_en": "The Moon",
        "image_url": get_card_image("The Moon"),
        "meaning": "ä¸å®‰ã€å¹»è¦º", "keywords": ["ææ‡¼", "è¿·æƒ˜"],
        "desc_up": "å‰æ–¹é“è·¯æ¨¡ç³Šä¸æ¸…ï¼Œå…§å¿ƒå……æ»¿ç–‘æ…®ï¼Œéœ€å°å¿ƒåˆ†è¾¨çœŸå¯¦èˆ‡è™›å¹»ã€‚",
        "desc_rev": "è¿·éœ§æ¼¸æ•£ã€çœŸç›¸å¤§ç™½ï¼Œæˆ–æ˜¯æ·±é™·ææ‡¼ä¹‹ä¸­ç„¡æ³•è‡ªæ‹”ã€‚"
    },
    {
        "name": "XIX. å¤ªé™½", "score": 1, "name_en": "The Sun",
        "image_url": get_card_image("The Sun"),
        "meaning": "æˆåŠŸã€æ´»åŠ›", "keywords": ["å…‰æ˜", "è‡ªä¿¡"],
        "desc_up": "é™°å½±æ•£å»ï¼Œæº«æš–çš„é™½å…‰æ™®ç…§ï¼Œå……æ»¿å–œæ‚…èˆ‡æˆåŠŸçš„èƒ½é‡ã€‚",
        "desc_rev": "æˆåŠŸå»¶é²ã€ç†±æƒ…æ¶ˆé€€ï¼Œæˆ–æ˜¯éåº¦è‡ªä¿¡å°è‡´çš„å¤±æ•—ã€‚"
    },
    {
        "name": "XX. å¯©åˆ¤", "score": 0, "name_en": "Judgement",
        "image_url": get_card_image("Judgement"),
        "meaning": "å¬å–šã€è¦ºé†’", "keywords": ["é‡ç”Ÿ", "åˆ¤æ–·"],
        "desc_up": "éå»çš„åŠªåŠ›å°‡è¢«çœ‹è¦‹ï¼Œç¾åœ¨æ˜¯åšå‡ºé‡å¤§æ±ºå®šèˆ‡æ”¹è®Šçš„æ™‚åˆ»ã€‚",
        "desc_rev": "é€ƒé¿è²¬ä»»ã€çŒ¶è±«ä¸æ±ºï¼Œæˆ–æ˜¯å› ç‚ºéå»çš„é™°å½±è€Œç„¡æ³•å‰é€²ã€‚"
    },
    {
        "name": "XXI. ä¸–ç•Œ", "score": 1, "name_en": "The World",
        "image_url": get_card_image("The World"),
        "meaning": "å®Œæˆã€åœ“æ»¿", "keywords": ["æˆå°±", "å®Œç¾"],
        "desc_up": "æ—…ç¨‹çš„çµ‚é»ï¼Œé”æˆç›®æ¨™ï¼Œäº«å—å®Œæ•´èˆ‡å’Œè«§çš„å¿«æ¨‚ã€‚",
        "desc_rev": "å°šæœªå®Œæˆã€ç¼ºä¹æœ€å¾Œä¸€æ­¥ï¼Œæˆ–æ˜¯æ„Ÿåˆ°ä¸æ»¿è¶³ã€æœ‰ç¼ºæ†¾çš„çµå±€ã€‚"
    },
]

# å¹¸é‹è³‡æ–™åº«
LUCKY_COLORS = ["æ·±é‚ƒè—", "ç†±æƒ…ç´…", "åƒå¤ªé™½ä¸€æ¨£çš„é‡‘é»ƒè‰²", "ç¥ç§˜ç´«", "ç´”æ·¨ç™½", "æ£®æ—ç¶ ", "å¤§åœ°è¤"]
LUCKY_NUMBERS = ["1", "3", "7", "8", "9", "11", "22"]

# å åœå¸«è¨­å®š (å‡ç´šï¼šæ¥µè‡´è±å¯Œçš„ Flex Message æ–‡æ¡ˆ)
TELLERS = {
    "1": {
        "name": "æœˆå…‰å¥³å£«",
        "desc": "æº«æŸ”å©‰ç´„ï¼Œåƒå§Šå§Šä¸€æ¨£æ’«æ…°äººå¿ƒã€‚",
        "intro": "è¦ªæ„›çš„ {name}ï¼Œå¤œæ·±äº†ï¼Œè®“æˆ‘å€‘è—‰ç”±æœˆå…‰çš„åŠ›é‡ï¼Œä»”ç´°æ¢³ç†é—œæ–¼ã€Œ{topic}ã€çš„æ™‚é–“ä¹‹æµ...",
        # --- è±å¯ŒåŒ–æ–‡æ¡ˆæ¨¡æ¿ ---
        "advice_improving": (
            "è¦ªæ„›çš„ {name} ({zodiac})ï¼Œæˆ‘ç‚ºä½ æ„Ÿåˆ°é«˜èˆˆï¼\n\n"
            "ğŸ“Š **èƒ½é‡åˆ†æ**ï¼š\n"
            "é€éç‰Œé™£æˆ‘çœ‹åˆ°äº†é™°éœ¾æ­£åœ¨æ•£å»ã€‚é›–ç„¶éå»çš„ã€Œ{past}ã€å¯èƒ½è®“ä½ å¿ƒåŠ›äº¤ç˜ï¼Œä½†è«‹ç›¸ä¿¡é‚£éƒ½æ˜¯ç‚ºäº†è®“ä½ è®Šå¾—æ›´å …å¼·ã€‚\n\n"
            "ğŸ›¡ï¸ **æ½›åœ¨ç™¼å±•**ï¼š\n"
            "æœªä¾†çš„ã€Œ{future}ã€é¡¯ç¤ºä½ çš„é‹å‹¢æ­£åœ¨é¡¯è‘—å›å‡ï¼Œé€™æ˜¯ä¸€å€‹éå¸¸æ­£å‘çš„è¨Šè™Ÿã€‚\n\n"
            "ğŸ’¡ **å°ˆå±¬æŒ‡å¼•**ï¼š\n"
            "æˆ‘çš„å»ºè­°æ˜¯ä¿æŒé–‹æ”¾çš„å¿ƒã€‚{todo}å°‡æœƒæ˜¯ä½ é–‹å•Ÿå¥½é‹çš„é‘°åŒ™ã€‚"
        ),
        "advice_declining": (
            "è¦ªæ„›çš„ {name} ({zodiac})ï¼Œé€™æˆ–è¨±ä¸æ˜¯ä½ æœ€æƒ³è½åˆ°çš„æ¶ˆæ¯ã€‚\n\n"
            "ğŸ“Š **èƒ½é‡åˆ†æ**ï¼š\n"
            "ç›®å‰çš„ç‹€æ³çœ‹ä¼¼å¹³ç©©ï¼Œä½†æœªä¾†çš„ã€Œ{future}ã€æš—ç¤ºè‘—ä¸€äº›ä¸ç¢ºå®šæ€§ã€‚ä½ å¯èƒ½åœ¨ã€Œ{present}ã€çš„ç‹€æ…‹ä¸­å¿½ç•¥äº†æŸäº›è­¦è¨Šã€‚\n\n"
            "ğŸ›¡ï¸ **æ½›åœ¨å•é¡Œ**ï¼š\n"
            "è«‹ä¸è¦é©šæ…Œï¼Œææ—©ç™¼ç¾å•é¡Œæ˜¯å¥½äº‹ã€‚ç¾åœ¨çš„å®‰é€¸å¯èƒ½åªæ˜¯æš«æ™‚çš„ã€‚\n\n"
            "ğŸ’¡ **å°ˆå±¬æŒ‡å¼•**ï¼š\n"
            "ç¾åœ¨é–‹å§‹è«‹æ”¾æ…¢è…³æ­¥ã€‚è©¦è‘—{todo}ï¼Œé€™èƒ½å¹«åŠ©ä½ ç©©ä½é™£è…³ã€‚"
        ),
        "advice_bad": (
            "è¾›è‹¦ä½ äº†ï¼Œ{name}ã€‚æˆ‘å¯ä»¥æ„Ÿå—åˆ°ä½ æ­¤åˆ»çš„ç–²æ†Šã€‚\n\n"
            "ğŸ“Š **èƒ½é‡åˆ†æ**ï¼š\n"
            "é€™çµ„ç‰Œé™£é¡¯ç¤ºå‡ºä½ æ­£é¢è‡¨ä¸å°çš„å£“åŠ›ï¼Œç‰¹åˆ¥æ˜¯ã€Œ{present}ã€é€™å¼µç‰Œï¼Œåæ˜ äº†ä½ å…§å¿ƒæ·±è™•çš„æ™æ‰èˆ‡ç„¡åŠ›æ„Ÿã€‚\n\n"
            "ğŸ›¡ï¸ **æ ¸å¿ƒç™¥çµ**ï¼š\n"
            "é€™ä¸¦ä¸æ˜¯ä½ çš„éŒ¯ï¼Œè€Œæ˜¯ç’°å¢ƒèƒ½é‡æš«æ™‚å—é˜»ã€‚ä½ å¯èƒ½è¦ºå¾—ç„¡è«–æ€éº¼åšéƒ½ç„¡æ³•çªç ´ã€‚\n\n"
            "ğŸ’¡ **å°ˆå±¬æŒ‡å¼•**ï¼š\n"
            "é»‘å¤œä¹‹å¾Œç¸½æœƒæœ‰é»æ˜ã€‚è«‹å…è¨±è‡ªå·±ä¼‘æ¯ï¼Œå¤šæ„›è‡ªå·±ä¸€é»ã€‚{todo}ï¼Œä½ æœƒç™¼ç¾è½‰æ©Ÿå¾€å¾€åœ¨æ”¾é¬†æ™‚å‡ºç¾ã€‚"
        ),
        "advice_good": (
            "å“‡ï¼{name} ({zodiac})ï¼Œä½ çš„èƒ½é‡å ´ç¾åœ¨éå¸¸è€€çœ¼å‘¢ï¼\n\n"
            "ğŸ“Š **èƒ½é‡åˆ†æ**ï¼š\n"
            "é€™æ˜¯ä¸€å€‹é›£å¾—çš„å¼·é‹æ™‚åˆ»ã€‚ã€Œ{present}ã€é¡¯ç¤ºä½ æ­£è™•æ–¼æ¥µä½³çš„ç‹€æ…‹ï¼Œä¸ç®¡æ˜¯è¡Œå‹•åŠ›é‚„æ˜¯ç›´è¦ºéƒ½éå¸¸æ•éŠ³ã€‚\n\n"
            "ğŸ›¡ï¸ **æœªä¾†å±•æœ›**ï¼š\n"
            "æœªä¾†çš„ã€Œ{future}ã€æ›´æ˜¯éŒ¦ä¸Šæ·»èŠ±ï¼Œå®‡å®™æ­£åœ¨å…¨åŠ›æ”¯æŒä½ çš„æ±ºå®šã€‚\n\n"
            "ğŸ’¡ **å°ˆå±¬æŒ‡å¼•**ï¼š\n"
            "è«‹ä¸è¦æµªè²»é€™æ®µå¥½é‹æ°£ï¼Œå‹‡æ•¢åœ°å»è¿½æ±‚ä½ çš„å¤¢æƒ³å§ï¼è¨˜å¾—{todo}ä¾†å»¶çºŒé€™ä»½å¥½é‹å–”ï¼"
        )
    },
    "2": {
        "name": "æ˜Ÿè¾°å¤§å¸«",
        "desc": "ä¸€é‡è¦‹è¡€ï¼Œåªå‘Šè¨´ä½ æ®˜é…·çš„ç¾å¯¦ã€‚",
        "intro": "å“¼ï¼Œ{name}ï¼Œæ—¢ç„¶ä½ èª å¿ƒèª æ„åœ°å•äº†ã€Œ{topic}ã€ï¼Œé‚£å°±å¼µå¤§çœ¼ç›çœ‹æ¸…æ¥šæ˜Ÿè±¡é¡¯ç¤ºçš„ç¾å¯¦ã€‚",
        "advice_improving": (
            "ç®—ä½ é‹æ°£å¥½ï¼Œ{name}ã€‚çœ‹ä¾†ä½ çµ‚æ–¼é–‹ç«…äº†ã€‚\n\n"
            "ğŸ“Š **å±€å‹¢åˆ†æ**ï¼š\n"
            "å›é ­çœ‹çœ‹é‚£å¼µã€Œ{past}ã€ï¼Œä½ è‡ªå·±ä¹ŸçŸ¥é“ä¹‹å‰æç ¸äº†å¤šå°‘äº‹æƒ…å§ï¼Ÿå¥½æ¶ˆæ¯æ˜¯ï¼Œé€™ä¸€åˆ‡çµ‚æ–¼è¦çµæŸäº†ã€‚\n\n"
            "ğŸ›¡ï¸ **é—œéµè½‰æŠ˜**ï¼š\n"
            "æœªä¾†çš„ã€Œ{future}ã€é¡¯ç¤ºå±€å‹¢æ­£åœ¨ç¿»è½‰ï¼Œæ©Ÿæœƒå·²ç¶“ä¾†åˆ°ä½ é¢å‰ã€‚\n\n"
            "ğŸ’¡ **å¤§å¸«è­¦å‘Š**ï¼š\n"
            "åˆ¥ä»¥ç‚ºé‹æ°£å¥½å°±å¯ä»¥æ‰ä»¥è¼•å¿ƒã€‚ç«‹åˆ»è¡Œå‹•ï¼Œå»{todo}ï¼Œåˆ¥å†æ‰¾è—‰å£äº†ï¼"
        ),
        "advice_declining": (
            "è½å¥½äº†ï¼Œ{name}ã€‚åˆ¥è¢«çœ¼å‰çš„å‡è±¡é¨™äº†ã€‚\n\n"
            "ğŸ“Š **å±€å‹¢åˆ†æ**ï¼š\n"
            "é›–ç„¶ç¾åœ¨æ˜¯ã€Œ{present}ã€ï¼Œçœ‹èµ·ä¾†å¥½åƒé¢¨å¹³æµªéœï¼Œä½†é€™åªæ˜¯æš´é¢¨é›¨å‰çš„å¯§éœã€‚\n\n"
            "ğŸ›¡ï¸ **å±æ©Ÿé è­¦**ï¼š\n"
            "å¦‚æœä½ ç¹¼çºŒä¿æŒç¾åœ¨é€™ç¨®æ“ºçˆ›çš„æ…‹åº¦ï¼Œæœªä¾†çš„ã€Œ{future}ã€çµ•å°æœƒçµ¦ä½ é‡é‡çš„ä¸€æ“Šã€‚\n\n"
            "ğŸ’¡ **å¤§å¸«è­¦å‘Š**ï¼š\n"
            "å¦‚æœä¸æƒ³æ‘”å¾—ç²‰èº«ç¢éª¨ï¼Œç¾åœ¨ç«‹åˆ»ç¹ƒç·Šç¥ç¶“ã€‚å»{todo}ï¼Œé€™æˆ–è¨±æ˜¯ä½ å”¯ä¸€çš„é¿é›£æ‰€ã€‚"
        ),
        "advice_bad": (
            "é€™ä»€éº¼çˆ›ç‰Œï¼Ÿæˆ‘éƒ½ä¸æƒ³è§£äº†ã€‚\n\n"
            "ğŸ“Š **å±€å‹¢åˆ†æ**ï¼š\n"
            "èº«ç‚º{zodiac}ï¼Œå¦‚æœä½ åªæœƒé€ƒé¿ç¾å¯¦ï¼Œé‚£æŠ½åˆ°ã€Œ{future}ã€é€™ç¨®çµå±€ä¹Ÿæ˜¯æ´»è©²ã€‚\n\n"
            "ğŸ›¡ï¸ **ç¾å¯¦å±¤é¢**ï¼š\n"
            "çœ‹çœ‹ã€Œ{present}ã€ï¼Œé€™å°±æ˜¯ä½ ä¸€æ‰‹é€ æˆçš„å±€é¢ï¼Œç¾åœ¨è¦ºå¾—ç—›è‹¦äº†å—ï¼Ÿ\n\n"
            "ğŸ’¡ **å¤§å¸«è­¦å‘Š**ï¼š\n"
            "é¢å°ç¾å¯¦å§ï¼Œæ²’æœ‰äººèƒ½å¹«ä½ ï¼Œé™¤äº†ä½ è‡ªå·±ã€‚å»{todo}ï¼Œé€™æ˜¯ä½ ç¾åœ¨å”¯ä¸€è©²åšçš„äº‹ã€‚"
        ),
        "advice_good": (
            "å“¼ï¼Œé›£å¾—çœ‹åˆ°é€™ç¨®å¼·é‹ã€‚é€£æ˜Ÿè±¡éƒ½ç«™åœ¨ä½ é€™é‚Šã€‚\n\n"
            "ğŸ“Š **å±€å‹¢åˆ†æ**ï¼š\n"
            "é€™çµ„ç‰Œæ²’ä»€éº¼å¥½æŒ‘å‰”çš„ï¼Œã€Œ{present}ã€å’Œã€Œ{future}ã€éƒ½é¡¯ç¤ºä½ çš„æ°£å‹¢æ­£æ—ºã€‚\n\n"
            "ğŸ›¡ï¸ **å„ªå‹¢è©•ä¼°**ï¼š\n"
            "èº«ç‚º{zodiac}ï¼Œå¦‚æœä½ æ‹¿è‘—é€™ä¸€æ‰‹å¥½ç‰Œé‚„èƒ½è¼¸æ‰ï¼Œé‚£æˆ‘ä¹Ÿæ˜¯æœäº†ä½ ã€‚\n\n"
            "ğŸ’¡ **å¤§å¸«è­¦å‘Š**ï¼š\n"
            "åˆ¥æµªè²»æ™‚é–“çŒ¶è±«äº†ï¼Œå¸¶è‘—é€™ä»½é‹æ°£å»è¡åˆºå§ã€‚è¨˜ä½ï¼Œå»{todo}ï¼Œåˆ¥è®“æ©Ÿæœƒè·‘äº†ã€‚"
        )
    },
    "3": {
        "name": "è²“å’ªå¡”ç¾…",
        "desc": "å–µå–µå–µï¼å¯æ„›è¼•é¬†ã€‚",
        "intro": "å–µï¼{name} æƒ³å•ã€Œ{topic}ã€å°å§ï¼Ÿè®“æœ¬å–µä¼¸å€‹æ‡¶è…°ï¼Œç”¨è‚‰çƒå¹«ä½ æ„Ÿæ‡‰ä¸€ä¸‹ï½",
        "advice_improving": (
            "å–µï½å¤ªæ£’äº†ï¼çƒé›²é€šé€šé£›èµ°å•¦ï¼\n\n"
            "ğŸ¾ **è‚‰çƒæ„Ÿæ‡‰**ï¼š\n"
            "ä¹‹å‰çš„ã€Œ{past}ã€å£å£ï¼Œè®“ä½ çš„å¿ƒæƒ…è®Šå¾—ç°ç°çš„ã€‚ä¸éåˆ¥æ“”å¿ƒï¼Œæ¥ä¸‹ä¾†æ˜¯å¥½åƒçš„ã€Œ{future}ã€ç½ç½å–”ï¼\n\n"
            "ğŸŒˆ **æœªä¾†å¤©æ°£**ï¼š\n"
            "é€™ä»£è¡¨é–‹å¿ƒçš„äº‹æƒ…å³å°‡ç™¼ç”Ÿï¼é™½å…‰æœƒæš–æš–åœ°ç…§åœ¨ä½ èº«ä¸Šã€‚\n\n"
            "ğŸˆ **è²“å’ªå»ºè­°**ï¼š\n"
            "{name}è¶•å¿«æŠŠé¬é¬šæ•´ç†å¥½ï¼Œæº–å‚™è¿æ¥å¥½é‹å§ï¼å»ºè­°ä½ å¯ä»¥{todo}ï¼Œæœƒæ›´å¿«æ¨‚å–”å–µï¼"
        ),
        "advice_declining": (
            "å‡¹å—š...æœ¬å–µèåˆ°ä¸€é»é»å±éšªçš„å‘³é“ï¼Œè€³æœµéƒ½å‚ä¸‹ä¾†äº†ã€‚\n\n"
            "ğŸ¾ **è‚‰çƒæ„Ÿæ‡‰**ï¼š\n"
            "é›–ç„¶ç¾åœ¨ä½ é‚„åœ¨é–‹å¿ƒåœ°ç©çƒçƒï¼Œä½†æ˜¯å°å¿ƒä¸­é–“è—è‘—é™·é˜±å–”ï¼\n\n"
            "â›ˆï¸ **æœªä¾†å¤©æ°£**ï¼š\n"
            "æœªä¾†çš„ã€Œ{future}ã€çœ‹èµ·ä¾†åƒæ˜¯æœƒä¸å°å¿ƒè¸©åˆ°å°¾å·´çš„æ„Ÿè¦ºã€‚é€™å¹¾å¤©å¯èƒ½æœƒæœ‰å°éº»ç…©æ‰¾ä¸Šé–€ã€‚\n\n"
            "ğŸˆ **è²“å’ªå»ºè­°**ï¼š\n"
            "é€™é™£å­è¦ä¹–ä¸€é»ï¼Œä¸è¦éš¨ä¾¿ç‚¸æ¯›ã€‚è©¦è‘—{todo}ï¼Œèº²åœ¨èˆ’æœçš„åœ°æ–¹é¿é¿é¢¨é ­å§å–µï¼"
        ),
        "advice_bad": (
            "å–µ...ï¼ˆè¹­è¹­ {name} çš„è…³ï¼‰ã€‚é€™å¹¾å¼µç‰Œçœ‹èµ·ä¾†å¿ƒæƒ…ä¸å¤ªå¥½ã€‚\n\n"
            "ğŸ¾ **è‚‰çƒæ„Ÿæ‡‰**ï¼š\n"
            "é›–ç„¶ã€Œ{present}ã€è®“ä½ è¦ºå¾—å¾ˆè¨å­ï¼Œåƒè¢«å¼·è¿«æ´—æ¾¡ä¸€æ¨£ä¸èˆ’æœï¼Œä½†åƒè¬ä¸è¦æ°£é¤’å–”ã€‚\n\n"
            "ğŸŒ§ï¸ **å¿ƒæƒ…å¤©æ°£**ï¼š\n"
            "è²“å’ªåœ¨è·Œå€’çš„æ™‚å€™ï¼Œéƒ½æœƒå„ªé›…åœ°ç«™èµ·ä¾†èˆ”èˆ”æ¯›ï¼Œå‡è£æ²’äº‹ã€‚\n\n"
            "ğŸˆ **è²“å’ªå»ºè­°**ï¼š\n"
            "ç´¯äº†å°±ç¡å€‹åˆè¦ºï¼Œæˆ–æ˜¯å»{todo}ï¼Œåƒé»å¥½åƒçš„ï¼Œæ˜å¤©åˆæ˜¯æ–°çš„ä¸€å¤©å–µï½"
        ),
        "advice_good": (
            "å‘¼åš•å‘¼åš•ï½é€™æ˜¯å¤§å‰å¤§åˆ©çš„é ‚ç´šè‚‰æ³¥å¤§é¤å•Šï¼\n\n"
            "ğŸ¾ **è‚‰çƒæ„Ÿæ‡‰**ï¼š\n"
            "{name}è¡å•Šï¼ä½ çš„é‹æ°£å¥½åˆ°é€£æœ¬å–µéƒ½æƒ³è¹­ä¸€è¹­ã€‚ã€Œ{present}ã€å’Œã€Œ{future}ã€éƒ½é–ƒé–ƒç™¼äº®ï¼\n\n"
            "â˜€ï¸ **æœªä¾†å¤©æ°£**ï¼š\n"
            "åƒæ˜¯å‰›æŠ“åˆ°çš„è¢ç«èŸ²ä¸€æ¨£æ¼‚äº®ï¼ä½ æ˜¯æœ€æ£’çš„è²“å’ªï¼ˆå–”ä¸æ˜¯ï¼Œäººé¡ï¼‰ï¼\n\n"
            "ğŸˆ **è²“å’ªå»ºè­°**ï¼š\n"
            "è¶•å¿«å»{todo}ï¼Œæ…¶ç¥é€™ç¾å¥½çš„ä¸€åˆ»å§å–µï¼"
        )
    }
}

VALID_ZODIACS = ["ç‰¡ç¾Šåº§", "é‡‘ç‰›åº§", "é›™å­åº§", "å·¨èŸ¹åº§", "ç…å­åº§", "è™•å¥³åº§", "å¤©ç§¤åº§", "å¤©è åº§", "å°„æ‰‹åº§", "æ‘©ç¾¯åº§", "æ°´ç“¶åº§", "é›™é­šåº§"]
user_db = {}
STATE_IDLE = 'IDLE' 
STATE_WAIT_NAME = 'WAIT_NAME'
STATE_WAIT_GENDER = 'WAIT_GENDER'
STATE_WAIT_BIRTHDAY = 'WAIT_BIRTHDAY'
STATE_WAIT_ZODIAC = 'WAIT_ZODIAC'
STATE_WAIT_TELLER = 'WAIT_TELLER' 
STATE_WAIT_TOPIC = 'WAIT_TOPIC'   

class TarotBotLogic:
    def __init__(self):
        print("ğŸ”® å¡”ç¾…ç‰Œæ©Ÿå™¨äººé‚è¼¯æ ¸å¿ƒå·²å•Ÿå‹• (v9.0 - è±å¯Œåˆ†æ+ä¿®å¾©åå­—ç‰ˆ)")

    def get_user(self, user_id):
        if user_id not in user_db:
            user_db[user_id] = {'state': STATE_IDLE, 'profile': {}, 'temp_data': {}}
        return user_db[user_id]

    def handle_message(self, user_id, message):
        user = self.get_user(user_id)
        state = user['state']
        text = message.strip()

        # æ¨¡æ“¬ Rich Menu çš„æŒ‰éˆ•è¡Œç‚º
        if text == "ğŸ”® é–‹å§‹å åœ": text = "å åœ"
        elif text == "ğŸ“– æŸ¥çœ‹è³‡æ–™": text = "æŸ¥çœ‹è³‡æ–™"
        elif text == "âš™ï¸ é‡æ–°è¨»å†Š": text = "é–‹å§‹è¨»å†Š"
        elif text == "â“ ä½¿ç”¨èªªæ˜": text = "èªªæ˜"

        if text in ["å–æ¶ˆ", "é€€å‡º"]:
            user['state'] = STATE_IDLE
            user['temp_data'] = {}
            return ["å·²å–æ¶ˆç›®å‰å‹•ä½œï¼Œå›åˆ°å¾…å‘½ç‹€æ…‹ã€‚"]

        if state in [STATE_WAIT_NAME, STATE_WAIT_GENDER, STATE_WAIT_BIRTHDAY, STATE_WAIT_ZODIAC, STATE_WAIT_TELLER]:
            return self._handle_registration(user_id, text)

        if state == STATE_WAIT_TOPIC:
            return self._handle_topic_selection(user_id, text)

        if not user['profile'] and text != "é–‹å§‹è¨»å†Š":
            return ["æ‚¨å¥½ï¼åœ¨ä½¿ç”¨å åœåŠŸèƒ½å‰ï¼Œè«‹è¼¸å…¥ã€Œé–‹å§‹è¨»å†Šã€ä¾†è¨­å®šæ‚¨çš„æª”æ¡ˆèˆ‡å°ˆå±¬å åœå¸«ã€‚"]

        if text == "é–‹å§‹è¨»å†Š":
            user['state'] = STATE_WAIT_NAME
            return ["æ²’å•é¡Œï¼Œé¦–å…ˆè«‹å‘Šè¨´æˆ‘ï¼Œæˆ‘è©²å¦‚ä½•ç¨±å‘¼æ‚¨ï¼Ÿ"]
        elif text == "æŸ¥çœ‹è³‡æ–™":
            p = user['profile']
            if not p: return ["æ‚¨å°šæœªè¨­å®šè³‡æ–™ã€‚"]
            teller = TELLERS.get(p.get('teller_id', "1"))
            return [f"æ‚¨çš„æª”æ¡ˆï¼š\nå§“å: {p.get('name')}\næ˜Ÿåº§: {p.get('zodiac')}\nå°ˆå±¬å åœå¸«: {teller['name']}"]
        elif text in ["å åœ", "æŠ½ç‰Œ", "ç®—å‘½"]:
            if not user['profile']: return ["è«‹å…ˆè¼¸å…¥ã€Œé–‹å§‹è¨»å†Šã€è¨­å®šè³‡æ–™ã€‚"]
            user['state'] = STATE_WAIT_TOPIC
            return ["è«‹è¼¸å…¥æ‚¨æƒ³è©¢å•çš„æ–¹å‘ï¼š\n(æ„›æƒ… / å·¥ä½œ / å­¸æ¥­ / æ•´é«”é‹å‹¢)"]
        elif text == "èªªæ˜":
            return ["æŒ‡ä»¤åˆ—è¡¨ï¼š\n- å åœ\n- æŸ¥çœ‹è³‡æ–™\n- é–‹å§‹è¨»å†Š\n- å–æ¶ˆ"]
        else:
            return ["æˆ‘ä¸æ˜ç™½æ‚¨çš„æ„æ€ï¼Œè©¦è©¦é»é¸ä¸‹æ–¹çš„é¸å–®æŒ‰éˆ•ï¼Ÿ"]

    def _handle_registration(self, user_id, text):
        user = user_db[user_id]
        state = user['state']
        if state == STATE_WAIT_NAME:
            user['temp_data']['name'] = text
            user['state'] = STATE_WAIT_GENDER
            return [f"å¥½çš„ {text}ï¼Œè«‹å•æ‚¨çš„æ€§åˆ¥æ˜¯ï¼Ÿ(ç”·/å¥³/å…¶ä»–)"]
        elif state == STATE_WAIT_GENDER:
            user['temp_data']['gender'] = text
            user['state'] = STATE_WAIT_BIRTHDAY
            return ["äº†è§£ã€‚è«‹è¼¸å…¥æ‚¨çš„å‡ºç”Ÿå¹´æœˆæ—¥ (æ ¼å¼ï¼šYYYY-MM-DD)"]
        elif state == STATE_WAIT_BIRTHDAY:
            try:
                datetime.strptime(text, "%Y-%m-%d")
                user['temp_data']['birthday'] = text
                user['state'] = STATE_WAIT_ZODIAC
                return ["æ”¶åˆ°ã€‚è«‹å•æ‚¨çš„æ˜Ÿåº§æ˜¯ï¼Ÿ"]
            except ValueError:
                return ["æ—¥æœŸæ ¼å¼éŒ¯èª¤å›‰ï¼è«‹ä¾ç…§ YYYY-MM-DD æ ¼å¼è¼¸å…¥ã€‚"]
        elif state == STATE_WAIT_ZODIAC:
            clean_text = text.replace(" ", "")
            if clean_text not in VALID_ZODIACS:
                if clean_text + "åº§" in VALID_ZODIACS: clean_text += "åº§"
                else: return [f"è«‹è¼¸å…¥æ­£ç¢ºçš„æ˜Ÿåº§åç¨±ï¼Œä¾‹å¦‚ï¼š{random.choice(VALID_ZODIACS)}"]
            user['temp_data']['zodiac'] = clean_text
            user['state'] = STATE_WAIT_TELLER 
            msg = "æœ€å¾Œï¼Œè«‹é¸æ“‡ä¸€ä½å°ˆå±¬å åœå¸«ç‚ºæ‚¨æœå‹™ (è«‹è¼¸å…¥æ•¸å­— 1-3)ï¼š\n"
            for tid, t_data in TELLERS.items():
                msg += f"\n[{tid}] {t_data['name']}: {t_data['desc']}"
            return [msg]
        elif state == STATE_WAIT_TELLER:
            if text not in TELLERS: return ["è«‹è¼¸å…¥ 1, 2 æˆ– 3ã€‚"]
            user['temp_data']['teller_id'] = text
            user['profile'] = user['temp_data'].copy()
            user['temp_data'] = {}
            user['state'] = STATE_IDLE
            teller_name = TELLERS[text]['name']
            return [f"è¨­å®šå®Œæˆï¼å°‡ç”±ã€Œ{teller_name}ã€ç‚ºæ‚¨æœå‹™ã€‚è©¦è©¦é»é¸ä¸‹æ–¹çš„ã€ğŸ”® é–‹å§‹å åœã€‘æŒ‰éˆ•å§ï¼"]
        return ["éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚"]

    def _handle_topic_selection(self, user_id, text):
        user = user_db[user_id]
        user['state'] = STATE_IDLE
        topic = text if text in ["æ„›æƒ…", "å·¥ä½œ", "å­¸æ¥­", "å¥åº·"] else "æ•´é«”é‹å‹¢"
        return self._perform_divination(user, topic)

    def _perform_divination(self, user, topic):
        raw_cards = random.sample(TAROT_DECK, 3)
        drawn_cards = []
        for card in raw_cards:
            is_reversed = random.choice([True, False])
            if is_reversed:
                display_name = f"{card['name']} (é€†ä½)"
                display_desc = card['desc_rev']
                current_score = card['score'] * -1
                status_icon = "ğŸ”»"
            else:
                display_name = f"{card['name']} (æ­£ä½)"
                display_desc = card['desc_up']
                current_score = card['score']
                status_icon = "ğŸ”º"
            
            drawn_cards.append({
                "name": display_name,
                "desc": display_desc,
                "score": current_score,
                "icon": status_icon,
                "meaning": card['meaning'],
                "keywords": card['keywords'],
                "image_url": card['image_url']
            })

        past, present, future = drawn_cards[0], drawn_cards[1], drawn_cards[2]
        
        p = user['profile']
        zodiac = p['zodiac']
        user_name = p['name'] # æŠ“å–ç”¨æˆ¶åå­—
        teller = TELLERS[p.get('teller_id', "1")]

        score_total = past['score'] + present['score'] + future['score']
        trend = future['score'] - past['score'] 
        scenario = ""
        if score_total >= 2: scenario = "advice_good"
        elif score_total <= -2: scenario = "advice_bad"
        elif trend > 0: scenario = "advice_improving"
        elif trend < 0: scenario = "advice_declining"
        else: scenario = "advice_good" if present['score'] >= 0 else "advice_bad"

        todo_list = ["å¤šè½æœ‹å‹æ„è¦‹", "ä¿æŒä½èª¿", "å¤§è†½å˜—è©¦", "å‡ºå»æ—…è¡Œ", "é–±è®€ä¸€æœ¬æ›¸", "æ•´ç†æˆ¿é–“", "è²·ä¸€ä»¶æ–°è¡£æœ"]
        
        # é€™è£¡çš„ format åŠ å…¥äº† name=user_nameï¼Œç¢ºä¿æ¨¡æ¿è£¡é¢çš„ {name} å¯ä»¥è¢«æ­£ç¢ºæ›¿æ›
        final_advice = teller[scenario].format(
            name=user_name,
            zodiac=zodiac,
            past=past['name'],
            present=present['name'],
            future=future['name'],
            todo=random.choice(todo_list)
        )

        lucky_color = random.choice(LUCKY_COLORS)
        lucky_num = random.choice(LUCKY_NUMBERS)

        # æ¨¡æ“¬ç”¢ç”Ÿæ›´æ¼‚äº®çš„ Flex Message é¡¯ç¤º
        flex_simulation = f"""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  ğŸ”® {teller['name']} çš„åˆ†æå¡ç‰‡      â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘  ğŸ‘¤ å°è±¡ï¼š{user_name} ({zodiac})
    â•‘  ğŸ·ï¸ ä¸»é¡Œï¼š{topic}
    â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
    â•‘  {final_advice.replace(chr(10), chr(10)+"    â•‘  ")}
    â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
    â•‘  ğŸ€ å¹¸é‹æŒ‡å—ï¼š
    â•‘  ğŸ¨ é¡è‰²ï¼š{lucky_color}
    â•‘  ğŸ”¢ æ•¸å­—ï¼š{lucky_num}
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """

        responses = [
            f"[{teller['name']} æ­£åœ¨é€£çµå®‡å®™èƒ½é‡...]",
            "...",
            f"ğŸ”® {topic}é‹å‹¢è©³ç´°è§£æ\n===================",
            teller['intro'].format(name=user_name, topic=topic),
            f"[ğŸ–¼ï¸ åœ–ç‰‡]: {past['image_url']}\n{past['icon']} {past['name']}\n{past['desc']}",
            f"[ğŸ–¼ï¸ åœ–ç‰‡]: {present['image_url']}\n{present['icon']} {present['name']}\n{present['desc']}",
            f"[ğŸ–¼ï¸ åœ–ç‰‡]: {future['image_url']}\n{future['icon']} {future['name']}\n{future['desc']}",
            "===================",
            flex_simulation
        ]
        return responses

# --- æœ¬æ©Ÿæ¨¡æ“¬ UI ä»‹é¢ ---
if __name__ == "__main__":
    bot = TarotBotLogic()
    print("----- æ¨¡æ“¬ LINE å°è©± (è¼¸å…¥ 'exit' é›¢é–‹) -----")
    uid = "user123"
    
    rich_menu_display = """
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     â‰¡ LINE åœ–æ–‡é¸å–® (æ¨¡æ“¬)    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ğŸ”® é–‹å§‹å åœ  â”‚ ğŸ“– æŸ¥çœ‹è³‡æ–™  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ âš™ï¸ é‡æ–°è¨»å†Š  â”‚ â“ ä½¿ç”¨èªªæ˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (è«‹ç›´æ¥è¼¸å…¥é¸å–®ä¸Šçš„æ–‡å­—ä¾†æ¨¡æ“¬é»æ“Š)
    """

    while True:
        try:
            print(rich_menu_display)
            txt = input(f"\n[ä½ ]: ")
            if txt.lower() == 'exit': break
            print("\n" * 2) 

            for res in bot.handle_message(uid, txt):
                time.sleep(0.8)
                print(f"[Bot]: {res}")
                
            print("\n" + "-"*30) 
            
        except KeyboardInterrupt: break